<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visit Validation Matcher</title>
    <style>
        :root {
            --color-primary: #208c8d;
            --color-primary-hover: #1d7474;
            --color-primary-active: #1a6473;
            --color-background: #fcfcf9;
            --color-surface: #ffffff;
            --color-text: #134252;
            --color-text-secondary: #626c71;
            --color-border: #5e5240;
            --color-error: #c0152f;
            --color-success: #208c8d;
            --color-warning: #a84b2f;
            --color-focus-ring: rgba(33, 128, 141, 0.4);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--color-background);
            color: var(--color-text);
            line-height: 1.5;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 28px;
            margin: 0 0 8px 0;
            font-weight: 600;
        }

        .subtitle {
            color: var(--color-text-secondary);
            margin-bottom: 24px;
            font-size: 14px;
        }

        .card {
            background: var(--color-surface);
            border: 1px solid rgba(94, 82, 64, 0.2);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .upload-box {
            border: 2px dashed rgba(94, 82, 64, 0.3);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 200ms ease;
        }

        .upload-box:hover {
            border-color: var(--color-primary);
            background: rgba(33, 128, 141, 0.02);
        }

        .upload-box input {
            display: none;
        }

        .upload-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--color-text);
            font-size: 14px;
        }

        .upload-hint {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .file-name {
            margin-top: 8px;
            font-size: 12px;
            color: var(--color-success);
            font-weight: 500;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms ease;
            display: inline-block !important;
            visibility: visible !important;
        }

        .btn-primary {
            background: var(--color-primary) !important;
            color: white !important;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--color-primary-hover) !important;
        }

        .btn-primary:active:not(:disabled) {
            background: var(--color-primary-active) !important;
        }

        .btn-primary:disabled {
            opacity: 0.5 !important;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: rgba(94, 82, 64, 0.05);
        }

        .btn-danger {
            background: var(--color-error) !important;
            color: white !important;
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(94, 82, 64, 0.2);
        }

        .tab-btn {
            padding: 12px 16px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--color-text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms ease;
        }

        .tab-btn.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .config-section {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(94, 82, 64, 0.1);
        }

        .config-section:last-child {
            border-bottom: none;
        }

        .config-section h3 {
            margin: 0 0 16px 0;
            font-size: 16px;
            font-weight: 600;
        }

        .config-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            align-items: center;
        }

        .config-row input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid rgba(94, 82, 64, 0.2);
            border-radius: 6px;
            font-size: 13px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .config-row button {
            padding: 8px 16px;
            flex-shrink: 0;
        }

        .sites-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 12px;
        }

        .site-tag {
            background: rgba(33, 128, 141, 0.1);
            border: 1px solid rgba(33, 128, 141, 0.3);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 13px;
            color: var(--color-text);
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .site-tag button {
            padding: 2px 6px;
            font-size: 11px;
            background: rgba(192, 21, 47, 0.2);
            color: var(--color-error);
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .site-tag button:hover {
            background: rgba(192, 21, 47, 0.3);
        }

        .help-text {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-top: 8px;
            line-height: 1.4;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat {
            background: var(--color-surface);
            border: 1px solid rgba(94, 82, 64, 0.2);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 600;
            color: var(--color-text);
        }

        .results-section {
            display: none;
        }

        .results-section.visible {
            display: block;
        }

        .table-wrapper {
            overflow-x: auto;
            border: 1px solid rgba(94, 82, 64, 0.2);
            border-radius: 6px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        thead {
            background: rgba(94, 82, 64, 0.05);
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--color-text);
            border-bottom: 1px solid rgba(94, 82, 64, 0.2);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid rgba(94, 82, 64, 0.1);
        }

        tr:hover {
            background: rgba(33, 128, 141, 0.02);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.visible {
            display: block;
        }

        .spinner {
            border: 3px solid rgba(33, 128, 141, 0.2);
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(192, 21, 47, 0.1);
            border: 1px solid var(--color-error);
            border-radius: 6px;
            padding: 12px;
            color: var(--color-error);
            margin-bottom: 16px;
            display: none;
            font-size: 13px;
        }

        .error-message.visible {
            display: block;
        }

        .success-message {
            background: rgba(32, 156, 141, 0.1);
            border: 1px solid var(--color-success);
            border-radius: 6px;
            padding: 12px;
            color: var(--color-success);
            margin-bottom: 16px;
            display: none;
            font-size: 13px;
        }

        .success-message.visible {
            display: block;
        }

        @media (max-width: 768px) {
            .upload-section {
                grid-template-columns: 1fr;
            }

            .summary {
                grid-template-columns: repeat(2, 1fr);
            }

            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Visit Validation Matcher</h1>
        <p class="subtitle">Upload your call log and data validation export to match and extract appointment data</p>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('matcher')">üìä Matcher</button>
            <button class="tab-btn" onclick="switchTab('config')">‚öôÔ∏è Configuration</button>
            <button class="tab-btn" onclick="switchTab('comparison')">üìã Sites & Studies</button>
        </div>

        <!-- MATCHER TAB -->
        <div id="matcherTab" class="tab-content active">
            <div class="card">
                <div class="error-message" id="errorMsg"></div>
                <div class="success-message" id="successMsg"></div>

                <div class="upload-section">
                    <div class="upload-box" onclick="document.getElementById('callFile').click()">
                        <label class="upload-label">üìÑ Grove Schedules</label>
                        <p class="upload-hint">Click to upload or drag & drop</p>
                        <input type="file" id="callFile" accept=".csv" />
                        <div class="file-name" id="callFileName"></div>
                    </div>

                    <div class="upload-box" onclick="document.getElementById('validationFile').click()">
                        <label class="upload-label">üìã CRIO Schedules</label>
                        <p class="upload-hint">Click to upload or drag & drop</p>
                        <input type="file" id="validationFile" accept=".csv" />
                        <div class="file-name" id="validationFileName"></div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn-primary" id="runBtn" onclick="runMatching()" disabled>Run Matching</button>
                    <button class="btn-secondary" onclick="resetForm()">Clear</button>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processing your files...</p>
            </div>

            <div class="results-section" id="resultsSection">
                <div class="card">
                    <h2 style="margin: 0 0 20px 0;">Results Summary</h2>
                    <div class="summary">
                        <div class="stat">
                            <div class="stat-label">Total Records</div>
                            <div class="stat-value" id="totalCount">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Matched</div>
                            <div class="stat-value" id="matchedCount" style="color: var(--color-success);">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Unmatched</div>
                            <div class="stat-value" id="unmatchedCount" style="color: var(--color-error);">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Success Rate</div>
                            <div class="stat-value" id="successRate">0%</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h2 style="margin: 0;">Matched Records (<span id="matchedDisplayCount">0</span>)</h2>
                        <button class="btn-primary" onclick="downloadMatched()">‚¨áÔ∏è Export Matched</button>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Patient</th>
                                    <th>Phone</th>
                                    <th>Site</th>
                                    <th>Study</th>
                                    <th>Validation Name</th>
                                    <th>Appointment Status</th>
                                    <th>Subject Status</th>
                                    <th>Cancellation Type</th>
                                </tr>
                            </thead>
                            <tbody id="matchedTable"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h2 style="margin: 0;">Unmatched Records (<span id="unmatchedDisplayCount">0</span>)</h2>
                        <button class="btn-primary" onclick="downloadUnmatched()">‚¨áÔ∏è Export Unmatched</button>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Patient</th>
                                    <th>Phone</th>
                                    <th>Site</th>
                                    <th>Study</th>
                                    <th>Issue</th>
                                </tr>
                            </thead>
                            <tbody id="unmatchedTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONFIGURATION TAB -->
        <div id="configTab" class="tab-content">
            <div class="card">
                <div class="config-section">
                    <h3>üìö Study Mappings</h3>
                    <p class="help-text">Add study keywords that will be recognized during matching. For example, if you add "BIPOLAR-101" with keyword "BIPOLAR", then "BIPOLAR Treatment Study" will map to "BIPOLAR-101".</p>
                    <div id="studyMappings"></div>
                    <button class="btn-primary" onclick="addStudyMapping()" style="margin-top: 12px;">+ Add Study Mapping</button>
                </div>

                <div class="config-section">
                    <h3>üè• Site Mappings</h3>
                    <p class="help-text">Add site abbreviations. For example, "NEW YORK" could map to "NY".</p>
                    <div id="siteMappings"></div>
                    <button class="btn-primary" onclick="addSiteMapping()" style="margin-top: 12px;">+ Add Site Mapping</button>
                </div>

                <div class="config-section">
                    <h3>Export / Import Settings</h3>
                    <p class="help-text">Save your mappings and share them with team members or use on another device.</p>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn-primary" onclick="exportConfig()">‚¨áÔ∏è Export Settings</button>
                        <button class="btn-primary" onclick="document.getElementById('importFile').click()">‚¨ÜÔ∏è Import Settings</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importConfig(event)" />
                    </div>
                </div>
            </div>
        </div>

        <!-- SITES & STUDIES TAB -->
        <div id="comparisonTab" class="tab-content">
            <div class="card">
                <h2 style="margin: 0 0 20px 0;">Discovered Sites & Studies</h2>
                <p class="help-text">Sites and studies are automatically discovered when you run matching. You can add or delete sites below to keep your configuration up to date as your studies evolve.</p>
                
                <div class="config-section">
                    <h3>üè• Discovered Sites</h3>
                    <p class="help-text">Manage sites that have been detected from your files.</p>
                    <div id="discoveredSitesList" class="sites-list">
                        <div style="grid-column: 1 / -1; color: var(--color-text-secondary); font-size: 13px;">Run matching first to discover sites</div>
                    </div>
                </div>

                <div class="config-section">
                    <h3>üìö Discovered Studies</h3>
                    <p class="help-text">Manage studies that have been detected from your files.</p>
                    <div id="discoveredStudiesList" class="sites-list">
                        <div style="grid-column: 1 / -1; color: var(--color-text-secondary); font-size: 13px;">Run matching first to discover studies</div>
                    </div>
                </div>

                <div class="config-section">
                    <h3>‚úèÔ∏è Manual Site Management</h3>
                    <p class="help-text">Add or remove sites manually as needed.</p>
                    <div class="config-row">
                        <input type="text" id="manualSiteInput" placeholder="Enter site name (e.g., NEW YORK)">
                        <button class="btn-primary" onclick="addManualSite()">Add Site</button>
                    </div>
                </div>

                <div class="config-section">
                    <h3>‚úèÔ∏è Manual Study Management</h3>
                    <p class="help-text">Add or remove studies manually as needed.</p>
                    <div class="config-row">
                        <input type="text" id="manualStudyInput" placeholder="Enter study name (e.g., BIPOLAR-101)">
                        <button class="btn-primary" onclick="addManualStudy()">Add Study</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ INITIALIZATION ============
        let matchedData = [];
        let unmatchedData = [];
        let discoveredSites = new Set();
        let discoveredStudies = new Set();
        let studyMappings = {};
        let siteMappings = {};

        // Load all data from localStorage on startup
        function initializeApp() {
            loadStudyMappings();
            loadSiteMappings();
            loadDiscoveredSites();
            loadDiscoveredStudies();
            renderStudyMappings();
            renderSiteMappings();
            updateDiscoveredSitesDisplay();
            updateDiscoveredStudiesDisplay();
        }

        // ============ LOCAL STORAGE FUNCTIONS ============
        function loadStudyMappings() {
            const saved = localStorage.getItem('studyMappings');
            studyMappings = saved ? JSON.parse(saved) : getDefaultStudyMappings();
        }

        function getDefaultStudyMappings() {
            return {
                'MRNA-1273': ['1273', 'MODERNA 1273'],
                'MRNA-1403': ['1403', 'MODERNA 1403'],
                'VAXCYTE': ['VAXCYTE', 'VAX31'],
                'NOVAVAX': ['NOVAVAX'],
                'VIKING': ['VIKING']
            };
        }

        function saveStudyMappings() {
            localStorage.setItem('studyMappings', JSON.stringify(studyMappings));
        }

        function loadSiteMappings() {
            const saved = localStorage.getItem('siteMappings');
            siteMappings = saved ? JSON.parse(saved) : {};
        }

        function saveSiteMappings() {
            localStorage.setItem('siteMappings', JSON.stringify(siteMappings));
        }

        function loadDiscoveredSites() {
            const saved = localStorage.getItem('discoveredSites');
            discoveredSites = new Set(saved ? JSON.parse(saved) : []);
        }

        function saveDiscoveredSites() {
            localStorage.setItem('discoveredSites', JSON.stringify(Array.from(discoveredSites)));
        }

        function loadDiscoveredStudies() {
            const saved = localStorage.getItem('discoveredStudies');
            discoveredStudies = new Set(saved ? JSON.parse(saved) : []);
        }

        function saveDiscoveredStudies() {
            localStorage.setItem('discoveredStudies', JSON.stringify(Array.from(discoveredStudies)));
        }

        // ============ STUDY MAPPINGS ============
        function renderStudyMappings() {
            const container = document.getElementById('studyMappings');
            if (Object.keys(studyMappings).length === 0) {
                container.innerHTML = '<p style="color: var(--color-text-secondary); font-size: 13px;">No study mappings yet.</p>';
                return;
            }

            container.innerHTML = Object.entries(studyMappings).map(([study, keywords], idx) => `
                <div class="config-row">
                    <input type="text" placeholder="Study Name" value="${escapeHtml(study)}" 
                           onchange="updateStudyMappingName(${idx}, this.value)">
                    <input type="text" placeholder="Keywords (comma-separated)" value="${escapeHtml(keywords.join(', '))}" 
                           onchange="updateStudyMappingKeywords(${idx}, this.value)">
                    <button class="btn-danger" onclick="deleteStudyMapping('${escapeHtml(study)}')">Delete</button>
                </div>
            `).join('');
        }

        function addStudyMapping() {
            const study = prompt('Enter study name (e.g., "BIPOLAR-101"):');
            if (!study || !study.trim()) return;
            const keyword = prompt('Enter primary keyword (e.g., "BIPOLAR"):');
            if (!keyword || !keyword.trim()) return;

            studyMappings[study.trim()] = [keyword.trim()];
            saveStudyMappings();
            renderStudyMappings();
        }

        function updateStudyMappingName(idx, newName) {
            const entries = Object.entries(studyMappings);
            const oldName = entries[idx][0];
            const keywords = studyMappings[oldName];

            delete studyMappings[oldName];
            studyMappings[newName.trim()] = keywords;
            saveStudyMappings();
        }

        function updateStudyMappingKeywords(idx, keywordStr) {
            const entries = Object.entries(studyMappings);
            const studyName = entries[idx][0];
            studyMappings[studyName] = keywordStr.split(',').map(k => k.trim()).filter(k => k);
            saveStudyMappings();
        }

        function deleteStudyMapping(study) {
            if (confirm(`Delete study mapping for "${study}"?`)) {
                delete studyMappings[study];
                saveStudyMappings();
                renderStudyMappings();
            }
        }

        // ============ SITE MAPPINGS ============
        function renderSiteMappings() {
            const container = document.getElementById('siteMappings');
            if (Object.keys(siteMappings).length === 0) {
                container.innerHTML = '<p style="color: var(--color-text-secondary); font-size: 13px;">No site mappings yet.</p>';
                return;
            }

            container.innerHTML = Object.entries(siteMappings).map(([fullName, abbr], idx) => `
                <div class="config-row">
                    <input type="text" placeholder="Full Site Name" value="${escapeHtml(fullName)}" 
                           onchange="updateSiteMappingName(${idx}, this.value)">
                    <input type="text" placeholder="Abbreviation" value="${escapeHtml(abbr)}" 
                           onchange="updateSiteMappingAbbr('${escapeHtml(fullName)}', this.value)">
                    <button class="btn-danger" onclick="deleteSiteMapping('${escapeHtml(fullName)}')">Delete</button>
                </div>
            `).join('');
        }

        function addSiteMapping() {
            const fullName = prompt('Enter full site name (e.g., "NEW YORK"):');
            if (!fullName || !fullName.trim()) return;
            const abbr = prompt('Enter abbreviation (e.g., "NY"):');
            if (!abbr || !abbr.trim()) return;

            siteMappings[fullName.trim()] = abbr.trim();
            saveSiteMappings();
            renderSiteMappings();
        }

        function updateSiteMappingName(idx, newName) {
            const entries = Object.entries(siteMappings);
            const oldName = entries[idx][0];
            const abbr = siteMappings[oldName];

            delete siteMappings[oldName];
            siteMappings[newName.trim()] = abbr;
            saveSiteMappings();
        }

        function updateSiteMappingAbbr(fullName, newAbbr) {
            siteMappings[fullName] = newAbbr.trim();
            saveSiteMappings();
        }

        function deleteSiteMapping(fullName) {
            if (confirm(`Delete site mapping for "${fullName}"?`)) {
                delete siteMappings[fullName];
                saveSiteMappings();
                renderSiteMappings();
            }
        }

        // ============ DISCOVERED SITES & STUDIES ============
        function updateDiscoveredSitesDisplay() {
            const container = document.getElementById('discoveredSitesList');
            if (discoveredSites.size === 0) {
                container.innerHTML = '<div style="grid-column: 1 / -1; color: var(--color-text-secondary); font-size: 13px;">Run matching first to discover sites</div>';
                return;
            }

            container.innerHTML = Array.from(discoveredSites).sort().map(site => `
                <div class="site-tag">
                    <span>${escapeHtml(site)}</span>
                    <button onclick="removeSite('${escapeHtml(site)}')">‚úï</button>
                </div>
            `).join('');
        }

        function updateDiscoveredStudiesDisplay() {
            const container = document.getElementById('discoveredStudiesList');
            if (discoveredStudies.size === 0) {
                container.innerHTML = '<div style="grid-column: 1 / -1; color: var(--color-text-secondary); font-size: 13px;">Run matching first to discover studies</div>';
                return;
            }

            container.innerHTML = Array.from(discoveredStudies).sort().map(study => `
                <div class="site-tag">
                    <span>${escapeHtml(study)}</span>
                    <button onclick="removeStudy('${escapeHtml(study)}')">‚úï</button>
                </div>
            `).join('');
        }

        function addManualSite() {
            const input = document.getElementById('manualSiteInput');
            const site = input.value.trim();
            if (!site) {
                showError('Please enter a site name');
                return;
            }

            if (discoveredSites.has(site)) {
                showError(`Site "${site}" already exists`);
                return;
            }

            discoveredSites.add(site);
            saveDiscoveredSites();
            updateDiscoveredSitesDisplay();
            input.value = '';
            showSuccess(`Site "${site}" added`);
        }

        function addManualStudy() {
            const input = document.getElementById('manualStudyInput');
            const study = input.value.trim();
            if (!study) {
                showError('Please enter a study name');
                return;
            }

            if (discoveredStudies.has(study)) {
                showError(`Study "${study}" already exists`);
                return;
            }

            discoveredStudies.add(study);
            saveDiscoveredStudies();
            updateDiscoveredStudiesDisplay();
            input.value = '';
            showSuccess(`Study "${study}" added`);
        }

        function removeSite(site) {
            if (confirm(`Remove site "${site}"?`)) {
                discoveredSites.delete(site);
                saveDiscoveredSites();
                updateDiscoveredSitesDisplay();
                showSuccess(`Site "${site}" removed`);
            }
        }

        function removeStudy(study) {
            if (confirm(`Remove study "${study}"?`)) {
                discoveredStudies.delete(study);
                saveDiscoveredStudies();
                updateDiscoveredStudiesDisplay();
                showSuccess(`Study "${study}" removed`);
            }
        }

        // ============ MATCHING LOGIC ============
        function cleanPhone(val) {
            if (!val || val === null) return null;
            const s = String(val).trim();
            const digits = s.replace(/\D/g, '');
            if (!digits) return null;
            return digits.length >= 10 ? digits.slice(-10) : digits;
        }

        function cleanSite(site) {
            if (!site || site === null) return null;
            const s = String(site).trim().toUpperCase();
            const first = s.split(/[\s\-]/)[0];
            return first;
        }

        function normalizeStudy(study) {
            if (!study || study === null) return 'UNKNOWN';
            const s = String(study).toUpperCase();

            // Check custom mappings
            for (const [studyName, keywords] of Object.entries(studyMappings)) {
                for (const keyword of keywords) {
                    if (s.includes(keyword.toUpperCase())) {
                        return studyName;
                    }
                }
            }

            return s.substring(0, 60);
        }

        function parseCSV(text) {
            const lines = text.split('\n').filter(l => l.trim());
            if (lines.length < 2) throw new Error('CSV file appears to be empty');

            const headers = lines[0].split(',').map(h => h.trim().replace(/^\"|\"$/g, ''));
            const rows = [];

            for (let i = 1; i < lines.length; i++) {
                const values = [];
                let current = '';
                let inQuotes = false;

                for (let j = 0; j < lines[i].length; j++) {
                    const char = lines[i][j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim().replace(/^\"|\"$/g, ''));
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim().replace(/^\"|\"$/g, ''));

                const row = {};
                headers.forEach((h, idx) => {
                    row[h] = values[idx] || '';
                });
                rows.push(row);
            }

            return { headers, rows };
        }

        function runMatching() {
            const callFile = document.getElementById('callFile').files[0];
            const valFile = document.getElementById('validationFile').files[0];

            if (!callFile || !valFile) {
                showError('Please upload both files');
                return;
            }

            document.getElementById('loading').classList.add('visible');
            document.getElementById('resultsSection').classList.remove('visible');
            clearMessages();

            Promise.all([
                callFile.text(),
                valFile.text()
            ]).then(([callText, valText]) => {
                const callData = parseCSV(callText);
                const valData = parseCSV(valText);
                performMatch(callData, valData);
            }).catch(err => {
                showError(`Error reading files: ${err.message}`);
                document.getElementById('loading').classList.remove('visible');
            });
        }

        function performMatch(callData, valData) {
            try {
                // Discover and save sites and studies
                discoveredSites.clear();
                discoveredStudies.clear();

                callData.rows.forEach(row => {
                    const site = row['SITE'];
                    if (site) discoveredSites.add(site);
                    const study = row['STUDY'];
                    if (study) discoveredStudies.add(study);
                });

                valData.rows.forEach(row => {
                    const site = row['Site Name'];
                    if (site) discoveredSites.add(site);
                    const study = row['Study Name'];
                    if (study) discoveredStudies.add(study);
                });

                saveDiscoveredSites();
                saveDiscoveredStudies();

                // Prepare validation data
                const valMap = new Map();
                valData.rows.forEach(row => {
                    const phoneClean = cleanPhone(row['Mobile Phone']);
                    const siteClean = cleanSite(row['Site Name']);
                    const studyNorm = normalizeStudy(row['Study Name']);

                    if (phoneClean && siteClean) {
                        const key = `${phoneClean}|${siteClean}|${studyNorm}`;
                        valMap.set(key, {
                            name: row['Subject Full Name'] || '',
                            phone: row['Mobile Phone'] || '',
                            appointmentStatus: row['Appointment Status'] || '',
                            subjectStatus: row['Subject Status'] || '',
                            cancellationType: row['Appointment Cancellation Type'] || ''
                        });
                    }
                });

                // Perform matching
                matchedData = [];
                unmatchedData = [];

                callData.rows.forEach(row => {
                    const phoneClean = cleanPhone(row['PHONE #']);
                    const siteClean = cleanSite(row['SITE']);
                    const studyNorm = normalizeStudy(row['STUDY']);
                    const key = `${phoneClean}|${siteClean}|${studyNorm}`;

                    const match = valMap.get(key);

                    if (match) {
                        matchedData.push({
                            patient: row['PATIENT'] || '',
                            phone: row['PHONE #'] || '',
                            site: row['SITE'] || '',
                            study: row['STUDY'] || '',
                            valName: match.name,
                            appointmentStatus: match.appointmentStatus,
                            subjectStatus: match.subjectStatus,
                            cancellationType: match.cancellationType
                        });
                    } else {
                        unmatchedData.push({
                            patient: row['PATIENT'] || '',
                            phone: row['PHONE #'] || '',
                            site: row['SITE'] || '',
                            study: row['STUDY'] || '',
                            issue: 'No match found'
                        });
                    }
                });

                displayResults();
                updateDiscoveredSitesDisplay();
                updateDiscoveredStudiesDisplay();
                document.getElementById('loading').classList.remove('visible');
                document.getElementById('resultsSection').classList.add('visible');
                showSuccess(`‚úì Matching complete: ${matchedData.length} matched, ${unmatchedData.length} unmatched`);

            } catch (err) {
                showError(`Matching error: ${err.message}`);
                document.getElementById('loading').classList.remove('visible');
            }
        }

        function displayResults() {
            const total = matchedData.length + unmatchedData.length;
            const matched = matchedData.length;
            const unmatched = unmatchedData.length;
            const rate = total > 0 ? Math.round((matched / total) * 100) : 0;

            document.getElementById('totalCount').textContent = total;
            document.getElementById('matchedCount').textContent = matched;
            document.getElementById('unmatchedCount').textContent = unmatched;
            document.getElementById('successRate').textContent = `${rate}%`;
            document.getElementById('matchedDisplayCount').textContent = matched;
            document.getElementById('unmatchedDisplayCount').textContent = unmatched;

            const matchedTable = document.getElementById('matchedTable');
            matchedTable.innerHTML = matchedData.map(row => `
                <tr>
                    <td>${escapeHtml(row.patient)}</td>
                    <td>${escapeHtml(row.phone)}</td>
                    <td>${escapeHtml(row.site)}</td>
                    <td>${escapeHtml(row.study)}</td>
                    <td>${escapeHtml(row.valName)}</td>
                    <td>${escapeHtml(row.appointmentStatus)}</td>
                    <td>${escapeHtml(row.subjectStatus)}</td>
                    <td>${escapeHtml(row.cancellationType)}</td>
                </tr>
            `).join('');

            const unmatchedTable = document.getElementById('unmatchedTable');
            unmatchedTable.innerHTML = unmatchedData.map(row => `
                <tr>
                    <td>${escapeHtml(row.patient)}</td>
                    <td>${escapeHtml(row.phone)}</td>
                    <td>${escapeHtml(row.site)}</td>
                    <td>${escapeHtml(row.study)}</td>
                    <td>${escapeHtml(row.issue)}</td>
                </tr>
            `).join('');
        }

        function downloadMatched() {
            const headers = ['PATIENT', 'PHONE #', 'SITE', 'STUDY', 'Validation_Name', 'Appointment Status', 'Subject Status', 'Appointment Cancellation Type'];
            const rows = matchedData.map(row => [
                row.patient, row.phone, row.site, row.study, row.valName,
                row.appointmentStatus, row.subjectStatus, row.cancellationType
            ]);
            downloadCSV(headers, rows, 'Matched_With_Validation.csv');
        }

        function downloadUnmatched() {
            const headers = ['PATIENT', 'PHONE #', 'SITE', 'STUDY', 'Issue'];
            const rows = unmatchedData.map(row => [row.patient, row.phone, row.site, row.study, row.issue]);
            downloadCSV(headers, rows, 'Unmatched_Records.csv');
        }

        function downloadCSV(headers, rows, filename) {
            const csv = [
                headers.map(h => `"${h}"`).join(','),
                ...rows.map(row => row.map(cell => `"${String(cell || '').replace(/"/g, '""')}"`).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = filename;
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportConfig() {
            const config = {
                studyMappings: studyMappings,
                siteMappings: siteMappings,
                discoveredSites: Array.from(discoveredSites),
                discoveredStudies: Array.from(discoveredStudies),
                exportDate: new Date().toISOString()
            };
            const json = JSON.stringify(config, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `matcher-config-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function importConfig(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const config = JSON.parse(e.target.result);
                    studyMappings = config.studyMappings || {};
                    siteMappings = config.siteMappings || {};
                    discoveredSites = new Set(config.discoveredSites || []);
                    discoveredStudies = new Set(config.discoveredStudies || []);

                    saveStudyMappings();
                    saveSiteMappings();
                    saveDiscoveredSites();
                    saveDiscoveredStudies();

                    renderStudyMappings();
                    renderSiteMappings();
                    updateDiscoveredSitesDisplay();
                    updateDiscoveredStudiesDisplay();

                    showSuccess('Settings imported successfully!');
                } catch (err) {
                    showError('Invalid config file format');
                }
            };
            reader.readAsText(file);
        }

        // ============ UI HANDLERS ============
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }

        document.getElementById('callFile')?.addEventListener('change', (e) => {
            const name = e.target.files[0]?.name || '';
            document.getElementById('callFileName').textContent = name ? `‚úì ${name}` : '';
            updateRunBtn();
        });

        document.getElementById('validationFile')?.addEventListener('change', (e) => {
            const name = e.target.files[0]?.name || '';
            document.getElementById('validationFileName').textContent = name ? `‚úì ${name}` : '';
            updateRunBtn();
        });

        function updateRunBtn() {
            const callFile = document.getElementById('callFile').files.length > 0;
            const valFile = document.getElementById('validationFile').files.length > 0;
            document.getElementById('runBtn').disabled = !callFile || !valFile;
        }

        function resetForm() {
            document.getElementById('callFile').value = '';
            document.getElementById('validationFile').value = '';
            document.getElementById('callFileName').textContent = '';
            document.getElementById('validationFileName').textContent = '';
            document.getElementById('resultsSection').classList.remove('visible');
            clearMessages();
            updateRunBtn();
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.classList.add('visible');
            setTimeout(() => el.classList.remove('visible'), 5000);
        }

        function showSuccess(msg) {
            const el = document.getElementById('successMsg');
            el.textContent = msg;
            el.classList.add('visible');
            setTimeout(() => el.classList.remove('visible'), 5000);
        }

        function clearMessages() {
            document.getElementById('errorMsg').classList.remove('visible');
            document.getElementById('successMsg').classList.remove('visible');
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
            };
            return String(text || '').replace(/[&<>"']/g, m => map[m]);
        }

        // Initialize app on load
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
