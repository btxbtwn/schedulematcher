<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visit Validation Matcher</title>
    <style>
        :root {
            --color-primary: #208c8d;
            --color-primary-hover: #1d7474;
            --color-primary-active: #1a6473;
            --color-background: #fcfcf9;
            --color-surface: #ffffff;
            --color-text: #134252;
            --color-text-secondary: #626c71;
            --color-border: #5e5240;
            --color-error: #c0152f;
            --color-success: #208c8d;
            --color-warning: #a84b2f;
            --color-focus-ring: rgba(33, 128, 141, 0.4);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--color-background);
            color: var(--color-text);
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            font-size: 28px;
            margin: 0 0 8px 0;
            font-weight: 600;
        }

        .subtitle {
            color: var(--color-text-secondary);
            margin-bottom: 24px;
            font-size: 14px;
        }

        .card {
            background: var(--color-surface);
            border: 1px solid rgba(94, 82, 64, 0.2);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .upload-box {
            border: 2px dashed rgba(94, 82, 64, 0.3);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 200ms ease;
        }

        .upload-box:hover {
            border-color: var(--color-primary);
            background: rgba(33, 128, 141, 0.02);
        }

        .upload-box input {
            display: none;
        }

        .upload-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--color-text);
            font-size: 14px;
        }

        .upload-hint {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .file-name {
            margin-top: 8px;
            font-size: 12px;
            color: var(--color-success);
            font-weight: 500;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms ease;
            display: inline-block !important;
            visibility: visible !important;
        }

        .btn-primary {
            background: var(--color-primary) !important;
            color: white !important;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--color-primary-hover) !important;
        }

        .btn-primary:active:not(:disabled) {
            background: var(--color-primary-active) !important;
        }

        .btn-primary:disabled {
            opacity: 0.5 !important;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: rgba(94, 82, 64, 0.05);
        }

        .btn-danger {
            background: var(--color-error) !important;
            color: white !important;
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(94, 82, 64, 0.2);
        }

        .tab-btn {
            padding: 12px 16px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--color-text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms ease;
        }

        .tab-btn.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .config-section {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(94, 82, 64, 0.1);
        }

        .config-section:last-child {
            border-bottom: none;
        }

        .config-section h3 {
            margin: 0 0 16px 0;
            font-size: 16px;
            font-weight: 600;
        }

        .drag-drop-area {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .source-column {
            min-height: 200px;
            background: rgba(94, 82, 64, 0.03);
            border: 2px dashed rgba(94, 82, 64, 0.2);
            border-radius: 8px;
            padding: 16px;
        }

        .column-header {
            font-weight: 600;
            font-size: 14px;
            color: var(--color-text);
            margin-bottom: 12px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .draggable-item {
            background: var(--color-surface);
            border: 1px solid rgba(94, 82, 64, 0.2);
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 8px;
            cursor: move;
            transition: all 200ms ease;
            font-size: 13px;
            position: relative;
        }

        .draggable-item:hover {
            border-color: var(--color-primary);
            background: rgba(33, 128, 141, 0.05);
        }

        .draggable-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .draggable-item.matched {
            background: rgba(32, 140, 141, 0.1);
            border-color: var(--color-success);
        }

        .match-indicator {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            color: var(--color-success);
        }

        .matches-column {
            background: rgba(32, 140, 141, 0.05);
            border: 2px solid rgba(32, 140, 141, 0.2);
            border-radius: 8px;
            padding: 16px;
            min-height: 200px;
        }

        .match-pair {
            background: var(--color-surface);
            border: 1px solid rgba(32, 140, 141, 0.3);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            display: grid;
            grid-template-columns: 1fr auto 1fr auto;
            gap: 8px;
            align-items: center;
            font-size: 13px;
        }

        .match-arrow {
            color: var(--color-primary);
            font-weight: bold;
        }

        .unmatch-btn {
            padding: 4px 8px;
            font-size: 11px;
            background: var(--color-error);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .unmatch-btn:hover {
            opacity: 0.8;
        }

        .drop-zone {
            border: 2px dashed var(--color-primary);
            background: rgba(33, 128, 141, 0.05);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: var(--color-text-secondary);
            font-size: 13px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drop-zone.drag-over {
            background: rgba(33, 128, 141, 0.15);
            border-color: var(--color-primary-active);
        }

        .help-text {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-top: 8px;
            line-height: 1.4;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat {
            background: var(--color-surface);
            border: 1px solid rgba(94, 82, 64, 0.2);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 600;
            color: var(--color-text);
        }

        .results-section {
            display: none;
        }

        .results-section.visible {
            display: block;
        }

        .table-wrapper {
            overflow-x: auto;
            border: 1px solid rgba(94, 82, 64, 0.2);
            border-radius: 6px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        thead {
            background: rgba(94, 82, 64, 0.05);
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--color-text);
            border-bottom: 1px solid rgba(94, 82, 64, 0.2);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid rgba(94, 82, 64, 0.1);
        }

        tr:hover {
            background: rgba(33, 128, 141, 0.02);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.visible {
            display: block;
        }

        .spinner {
            border: 3px solid rgba(33, 128, 141, 0.2);
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(192, 21, 47, 0.1);
            border: 1px solid var(--color-error);
            border-radius: 6px;
            padding: 12px;
            color: var(--color-error);
            margin-bottom: 16px;
            display: none;
            font-size: 13px;
        }

        .error-message.visible {
            display: block;
        }

        .success-message {
            background: rgba(32, 156, 141, 0.1);
            border: 1px solid var(--color-success);
            border-radius: 6px;
            padding: 12px;
            color: var(--color-success);
            margin-bottom: 16px;
            display: none;
            font-size: 13px;
        }

        .success-message.visible {
            display: block;
        }

        .info-badge {
            display: inline-block;
            background: rgba(33, 128, 141, 0.1);
            color: var(--color-primary);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 8px;
        }

        @media (max-width: 768px) {
            .upload-section {
                grid-template-columns: 1fr;
            }

            .summary {
                grid-template-columns: repeat(2, 1fr);
            }

            button {
                width: 100%;
            }

            .drag-drop-area {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Visit Validation Matcher</h1>
        <p class="subtitle">Upload your call log and data validation export to match and extract appointment data</p>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('matcher')">üìä Matcher</button>
            <button class="tab-btn" onclick="switchTab('config')">üè• Sites and Studies</button>
        </div>

        <!-- MATCHER TAB -->
        <div id="matcherTab" class="tab-content active">
            <div class="card">
                <div class="error-message" id="errorMsg"></div>
                <div class="success-message" id="successMsg"></div>

                <div class="upload-section">
                    <div class="upload-box" onclick="document.getElementById('callFile').click()">
                        <label class="upload-label">üìÑ Grove Schedules</label>
                        <p class="upload-hint">Click to upload or drag & drop</p>
                        <input type="file" id="callFile" accept=".csv" />
                        <div class="file-name" id="callFileName"></div>
                    </div>

                    <div class="upload-box" onclick="document.getElementById('validationFile').click()">
                        <label class="upload-label">üìã CRIO Schedules</label>
                        <p class="upload-hint">Click to upload or drag & drop</p>
                        <input type="file" id="validationFile" accept=".csv" />
                        <div class="file-name" id="validationFileName"></div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn-primary" id="runBtn" onclick="runMatching()" disabled>Run Matching</button>
                    <button class="btn-secondary" onclick="resetForm()">Clear</button>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processing your files...</p>
            </div>

            <div class="results-section" id="resultsSection">
                <div class="card">
                    <h2 style="margin: 0 0 20px 0;">Results Summary</h2>
                    <div class="summary">
                        <div class="stat">
                            <div class="stat-label">Total Records</div>
                            <div class="stat-value" id="totalCount">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Matched</div>
                            <div class="stat-value" id="matchedCount" style="color: var(--color-success);">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Unmatched</div>
                            <div class="stat-value" id="unmatchedCount" style="color: var(--color-error);">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Success Rate</div>
                            <div class="stat-value" id="successRate">0%</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h2 style="margin: 0;">Matched Records (<span id="matchedDisplayCount">0</span>)</h2>
                        <button class="btn-primary" onclick="downloadMatched()">‚¨áÔ∏è Export Matched</button>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Patient</th>
                                    <th>Phone</th>
                                    <th>Site</th>
                                    <th>Study</th>
                                    <th>Validation Name</th>
                                    <th>Appointment Status</th>
                                    <th>Subject Status</th>
                                    <th>Cancellation Type</th>
                                </tr>
                            </thead>
                            <tbody id="matchedTable"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h2 style="margin: 0;">Unmatched Records (<span id="unmatchedDisplayCount">0</span>)</h2>
                        <button class="btn-primary" onclick="downloadUnmatched()">‚¨áÔ∏è Export Unmatched</button>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Patient</th>
                                    <th>Phone</th>
                                    <th>Site</th>
                                    <th>Study</th>
                                    <th>Issue</th>
                                </tr>
                            </thead>
                            <tbody id="unmatchedTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- SITES AND STUDIES TAB -->
        <div id="configTab" class="tab-content">
            <div class="card">
                <div class="config-section">
                    <h3>üè• Site Mappings<span class="info-badge" id="siteMappingCount">0 mappings</span></h3>
                    <p class="help-text">Drag Grove sites and drop them onto matching CRIO sites (or vice versa) to create pairs. Sites are automatically discovered when you upload files.</p>
                    
                    <div class="drag-drop-area">
                        <div class="source-column">
                            <div class="column-header">Grove Sites</div>
                            <div id="groveSitesList"></div>
                        </div>
                        
                        <div style="display: flex; align-items: center; justify-content: center; padding: 20px;">
                            <div style="font-size: 24px; color: var(--color-primary);">‚ü∑</div>
                        </div>
                        
                        <div class="source-column">
                            <div class="column-header">CRIO Sites</div>
                            <div id="crioSitesList"></div>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <div class="column-header" style="margin-bottom: 12px;">Matched Pairs</div>
                        <div id="siteMatches"></div>
                    </div>
                </div>

                <div class="config-section">
                    <h3>üìö Study Mappings<span class="info-badge" id="studyMappingCount">0 mappings</span></h3>
                    <p class="help-text">Drag Grove studies and drop them onto matching CRIO studies (or vice versa) to create pairs. Studies are automatically discovered when you upload files.</p>
                    
                    <div class="drag-drop-area">
                        <div class="source-column">
                            <div class="column-header">Grove Studies</div>
                            <div id="groveStudiesList"></div>
                        </div>
                        
                        <div style="display: flex; align-items: center; justify-content: center; padding: 20px;">
                            <div style="font-size: 24px; color: var(--color-primary);">‚ü∑</div>
                        </div>
                        
                        <div class="source-column">
                            <div class="column-header">CRIO Studies</div>
                            <div id="crioStudiesList"></div>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <div class="column-header" style="margin-bottom: 12px;">Matched Pairs</div>
                        <div id="studyMatches"></div>
                    </div>
                </div>

                <div class="config-section">
                    <h3>üíæ Export / Import Settings</h3>
                    <p class="help-text">Save your mappings and share them with team members or use on another device.</p>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn-primary" onclick="exportConfig()">‚¨áÔ∏è Export Settings</button>
                        <button class="btn-primary" onclick="document.getElementById('importFile').click()">‚¨ÜÔ∏è Import Settings</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importConfig(event)" />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ INITIALIZATION ============
        let matchedData = [];
        let unmatchedData = [];
        let siteMappings = [];
        let studyMappings = [];
        let discoveredGroveSites = new Set();
        let discoveredCrioSites = new Set();
        let discoveredGroveStudies = new Set();
        let discoveredCrioStudies = new Set();
        let draggedItem = null;
        let dragSource = null;

        // Load all data from localStorage on startup
        function initializeApp() {
            loadSiteMappings();
            loadStudyMappings();
            renderDragDropInterface();
        }

        // ============ LOCAL STORAGE FUNCTIONS ============
        function loadSiteMappings() {
            const saved = localStorage.getItem('siteMappings');
            siteMappings = saved ? JSON.parse(saved) : [];
        }

        function saveSiteMappings() {
            localStorage.setItem('siteMappings', JSON.stringify(siteMappings));
        }

        function loadStudyMappings() {
            const saved = localStorage.getItem('studyMappings');
            studyMappings = saved ? JSON.parse(saved) : getDefaultStudyMappings();
        }

        function getDefaultStudyMappings() {
            return [
                { grove: 'MRNA-1273', crio: '1273' },
                { grove: 'MRNA-1273', crio: 'MODERNA 1273' },
                { grove: 'MRNA-1403', crio: '1403' },
                { grove: 'MRNA-1403', crio: 'MODERNA 1403' },
                { grove: 'VAXCYTE', crio: 'VAX31' },
                { grove: 'NOVAVAX', crio: 'NOVAVAX' },
                { grove: 'VIKING', crio: 'VIKING' }
            ];
        }

        function saveStudyMappings() {
            localStorage.setItem('studyMappings', JSON.stringify(studyMappings));
        }

        // ============ AUTO-DISCOVERY FROM FILES ============
        function discoverFromFiles() {
            const callFile = document.getElementById('callFile').files[0];
            const valFile = document.getElementById('validationFile').files[0];

            if (!callFile && !valFile) return;

            Promise.all([
                callFile ? callFile.text() : Promise.resolve(null),
                valFile ? valFile.text() : Promise.resolve(null)
            ]).then(([callText, valText]) => {
                if (callText) {
                    const callData = parseCSV(callText);
                    extractGroveData(callData);
                }
                if (valText) {
                    const valData = parseCSV(valText);
                    extractCrioData(valData);
                }
                renderDragDropInterface();
                showSuccess('‚úì Files analyzed! Sites and studies discovered. Go to Sites and Studies tab to match them.');
            }).catch(err => {
                console.error('Discovery error:', err);
            });
        }

        function extractGroveData(data) {
            data.rows.forEach(row => {
                const site = row['SITE'];
                const study = row['STUDY'];
                if (site && site.trim()) discoveredGroveSites.add(site.trim());
                if (study && study.trim()) discoveredGroveStudies.add(study.trim());
            });
        }

        function extractCrioData(data) {
            data.rows.forEach(row => {
                const site = row['Site Name'];
                const study = row['Study Name'];
                if (site && site.trim()) discoveredCrioSites.add(site.trim());
                if (study && study.trim()) discoveredCrioStudies.add(study.trim());
            });
        }

        // ============ DRAG AND DROP INTERFACE ============
        function renderDragDropInterface() {
            renderSiteDragDrop();
            renderStudyDragDrop();
            updateMappingCounts();
        }

        function renderSiteDragDrop() {
            const groveList = document.getElementById('groveSitesList');
            const crioList = document.getElementById('crioSitesList');
            const matchesList = document.getElementById('siteMatches');

            // Get mapped items
            const mappedGrove = new Set(siteMappings.map(m => m.grove).filter(g => g));
            const mappedCrio = new Set(siteMappings.map(m => m.crio).filter(c => c));

            // Render Grove sites
            const groveSites = Array.from(discoveredGroveSites).filter(s => !mappedGrove.has(s));
            groveList.innerHTML = groveSites.length > 0 
                ? groveSites.map(site => createDraggableItem(site, 'grove', 'site')).join('')
                : '<div class="drop-zone">No unmatched Grove sites</div>';

            // Render CRIO sites
            const crioSites = Array.from(discoveredCrioSites).filter(s => !mappedCrio.has(s));
            crioList.innerHTML = crioSites.length > 0
                ? crioSites.map(site => createDraggableItem(site, 'crio', 'site')).join('')
                : '<div class="drop-zone">No unmatched CRIO sites</div>';

            // Render matches
            matchesList.innerHTML = siteMappings.length > 0
                ? siteMappings.map((mapping, idx) => createMatchPair(mapping.grove, mapping.crio, idx, 'site')).join('')
                : '<div class="drop-zone">Drag items here to create matches</div>';

            attachDragListeners();
        }

        function renderStudyDragDrop() {
            const groveList = document.getElementById('groveStudiesList');
            const crioList = document.getElementById('crioStudiesList');
            const matchesList = document.getElementById('studyMatches');

            // Get mapped items
            const mappedGrove = new Set(studyMappings.map(m => m.grove).filter(g => g));
            const mappedCrio = new Set(studyMappings.map(m => m.crio).filter(c => c));

            // Render Grove studies
            const groveStudies = Array.from(discoveredGroveStudies).filter(s => !mappedGrove.has(s));
            groveList.innerHTML = groveStudies.length > 0
                ? groveStudies.map(study => createDraggableItem(study, 'grove', 'study')).join('')
                : '<div class="drop-zone">No unmatched Grove studies</div>';

            // Render CRIO studies
            const crioStudies = Array.from(discoveredCrioStudies).filter(s => !mappedCrio.has(s));
            crioList.innerHTML = crioStudies.length > 0
                ? crioStudies.map(study => createDraggableItem(study, 'crio', 'study')).join('')
                : '<div class="drop-zone">No unmatched CRIO studies</div>';

            // Render matches
            matchesList.innerHTML = studyMappings.length > 0
                ? studyMappings.map((mapping, idx) => createMatchPair(mapping.grove, mapping.crio, idx, 'study')).join('')
                : '<div class="drop-zone">Drag items here to create matches</div>';

            attachDragListeners();
        }

        function createDraggableItem(name, source, type) {
            return `
                <div class="draggable-item" draggable="true" data-name="${escapeHtml(name)}" data-source="${source}" data-type="${type}">
                    ${escapeHtml(name)}
                </div>
            `;
        }

        function createMatchPair(grove, crio, index, type) {
            return `
                <div class="match-pair">
                    <div>${escapeHtml(grove || '(empty)')}</div>
                    <div class="match-arrow">‚Üí</div>
                    <div>${escapeHtml(crio || '(empty)')}</div>
                    <button class="unmatch-btn" onclick="unmatchPair(${index}, '${type}')">‚úï</button>
                </div>
            `;
        }

        function attachDragListeners() {
            const draggables = document.querySelectorAll('.draggable-item');
            const dropZones = document.querySelectorAll('.source-column, #siteMatches, #studyMatches');

            draggables.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
            });

            dropZones.forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('drop', handleDrop);
                zone.addEventListener('dragleave', handleDragLeave);
            });
        }

        function handleDragStart(e) {
            draggedItem = {
                name: e.target.dataset.name,
                source: e.target.dataset.source,
                type: e.target.dataset.type
            };
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            if (e.currentTarget.classList.contains('source-column') || 
                e.currentTarget.id === 'siteMatches' || 
                e.currentTarget.id === 'studyMatches') {
                e.currentTarget.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');

            if (!draggedItem) return;

            const dropZoneId = e.currentTarget.id;
            const dropZoneClasses = Array.from(e.currentTarget.classList);

            // Find the draggable item under the cursor
            const dropTarget = e.target.closest('.draggable-item');

            if (dropTarget && dropTarget.dataset.name !== draggedItem.name) {
                // Dropped on another item - create a match
                const targetName = dropTarget.dataset.name;
                const targetSource = dropTarget.dataset.source;

                if (draggedItem.type === 'site') {
                    const mapping = {
                        grove: draggedItem.source === 'grove' ? draggedItem.name : targetName,
                        crio: draggedItem.source === 'crio' ? draggedItem.name : targetName
                    };
                    siteMappings.push(mapping);
                    saveSiteMappings();
                    renderSiteDragDrop();
                } else if (draggedItem.type === 'study') {
                    const mapping = {
                        grove: draggedItem.source === 'grove' ? draggedItem.name : targetName,
                        crio: draggedItem.source === 'crio' ? draggedItem.name : targetName
                    };
                    studyMappings.push(mapping);
                    saveStudyMappings();
                    renderStudyDragDrop();
                }
                showSuccess(`‚úì Matched: ${draggedItem.name} ‚Üî ${targetName}`);
            }

            draggedItem = null;
            updateMappingCounts();
        }

        function unmatchPair(index, type) {
            if (type === 'site') {
                siteMappings.splice(index, 1);
                saveSiteMappings();
                renderSiteDragDrop();
            } else if (type === 'study') {
                studyMappings.splice(index, 1);
                saveStudyMappings();
                renderStudyDragDrop();
            }
            updateMappingCounts();
        }

        function updateMappingCounts() {
            document.getElementById('siteMappingCount').textContent = 
                `${siteMappings.length} mapping${siteMappings.length !== 1 ? 's' : ''}`;
            document.getElementById('studyMappingCount').textContent = 
                `${studyMappings.length} mapping${studyMappings.length !== 1 ? 's' : ''}`;
        }

        // ============ MATCHING LOGIC ============
        function cleanPhone(val) {
            if (!val || val === null) return null;
            const s = String(val).trim();
            const digits = s.replace(/\D/g, '');
            if (!digits) return null;
            return digits.length >= 10 ? digits.slice(-10) : digits;
        }

        function normalizeSite(site, source) {
            if (!site || site === null) return null;
            const s = String(site).trim().toUpperCase();
            
            for (const mapping of siteMappings) {
                if (!mapping.grove || !mapping.crio) continue;
                const groveUpper = mapping.grove.toUpperCase();
                const crioUpper = mapping.crio.toUpperCase();
                
                if (source === 'grove' && s.includes(groveUpper)) {
                    return groveUpper;
                } else if (source === 'crio' && s.includes(crioUpper)) {
                    return mapping.grove.toUpperCase();
                }
            }
            
            return s.split(/[\s\-]/)[0];
        }

        function normalizeStudy(study, source) {
            if (!study || study === null) return 'UNKNOWN';
            const s = String(study).toUpperCase();

            for (const mapping of studyMappings) {
                if (!mapping.grove || !mapping.crio) continue;
                const groveUpper = mapping.grove.toUpperCase();
                const crioUpper = mapping.crio.toUpperCase();
                
                if (source === 'grove' && s.includes(groveUpper)) {
                    return groveUpper;
                } else if (source === 'crio' && s.includes(crioUpper)) {
                    return mapping.grove.toUpperCase();
                }
            }

            return s.substring(0, 60);
        }

        function parseCSV(text) {
            const lines = text.split('\n').filter(l => l.trim());
            if (lines.length < 2) throw new Error('CSV file appears to be empty');

            const headers = lines[0].split(',').map(h => h.trim().replace(/^\"|\"$/g, ''));
            const rows = [];

            for (let i = 1; i < lines.length; i++) {
                const values = [];
                let current = '';
                let inQuotes = false;

                for (let j = 0; j < lines[i].length; j++) {
                    const char = lines[i][j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim().replace(/^\"|\"$/g, ''));
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim().replace(/^\"|\"$/g, ''));

                const row = {};
                headers.forEach((h, idx) => {
                    row[h] = values[idx] || '';
                });
                rows.push(row);
            }

            return { headers, rows };
        }

        function runMatching() {
            const callFile = document.getElementById('callFile').files[0];
            const valFile = document.getElementById('validationFile').files[0];

            if (!callFile || !valFile) {
                showError('Please upload both files');
                return;
            }

            document.getElementById('loading').classList.add('visible');
            document.getElementById('resultsSection').classList.remove('visible');
            clearMessages();

            Promise.all([
                callFile.text(),
                valFile.text()
            ]).then(([callText, valText]) => {
                const callData = parseCSV(callText);
                const valData = parseCSV(valText);
                performMatch(callData, valData);
            }).catch(err => {
                showError(`Error reading files: ${err.message}`);
                document.getElementById('loading').classList.remove('visible');
            });
        }

        function performMatch(callData, valData) {
            try {
                const valMap = new Map();
                valData.rows.forEach(row => {
                    const phoneClean = cleanPhone(row['Mobile Phone']);
                    const siteNorm = normalizeSite(row['Site Name'], 'crio');
                    const studyNorm = normalizeStudy(row['Study Name'], 'crio');

                    if (phoneClean && siteNorm) {
                        const key = `${phoneClean}|${siteNorm}|${studyNorm}`;
                        valMap.set(key, {
                            name: row['Subject Full Name'] || '',
                            phone: row['Mobile Phone'] || '',
                            appointmentStatus: row['Appointment Status'] || '',
                            subjectStatus: row['Subject Status'] || '',
                            cancellationType: row['Appointment Cancellation Type'] || ''
                        });
                    }
                });

                matchedData = [];
                unmatchedData = [];

                callData.rows.forEach(row => {
                    const phoneClean = cleanPhone(row['PHONE #']);
                    const siteNorm = normalizeSite(row['SITE'], 'grove');
                    const studyNorm = normalizeStudy(row['STUDY'], 'grove');
                    const key = `${phoneClean}|${siteNorm}|${studyNorm}`;

                    const match = valMap.get(key);

                    if (match) {
                        matchedData.push({
                            patient: row['PATIENT'] || '',
                            phone: row['PHONE #'] || '',
                            site: row['SITE'] || '',
                            study: row['STUDY'] || '',
                            valName: match.name,
                            appointmentStatus: match.appointmentStatus,
                            subjectStatus: match.subjectStatus,
                            cancellationType: match.cancellationType
                        });
                    } else {
                        unmatchedData.push({
                            patient: row['PATIENT'] || '',
                            phone: row['PHONE #'] || '',
                            site: row['SITE'] || '',
                            study: row['STUDY'] || '',
                            issue: 'No match found'
                        });
                    }
                });

                displayResults();
                document.getElementById('loading').classList.remove('visible');
                document.getElementById('resultsSection').classList.add('visible');
                showSuccess(`‚úì Matching complete: ${matchedData.length} matched, ${unmatchedData.length} unmatched`);

            } catch (err) {
                showError(`Matching error: ${err.message}`);
                document.getElementById('loading').classList.remove('visible');
            }
        }

        function displayResults() {
            const total = matchedData.length + unmatchedData.length;
            const matched = matchedData.length;
            const unmatched = unmatchedData.length;
            const rate = total > 0 ? Math.round((matched / total) * 100) : 0;

            document.getElementById('totalCount').textContent = total;
            document.getElementById('matchedCount').textContent = matched;
            document.getElementById('unmatchedCount').textContent = unmatched;
            document.getElementById('successRate').textContent = `${rate}%`;
            document.getElementById('matchedDisplayCount').textContent = matched;
            document.getElementById('unmatchedDisplayCount').textContent = unmatched;

            const matchedTable = document.getElementById('matchedTable');
            matchedTable.innerHTML = matchedData.map(row => `
                <tr>
                    <td>${escapeHtml(row.patient)}</td>
                    <td>${escapeHtml(row.phone)}</td>
                    <td>${escapeHtml(row.site)}</td>
                    <td>${escapeHtml(row.study)}</td>
                    <td>${escapeHtml(row.valName)}</td>
                    <td>${escapeHtml(row.appointmentStatus)}</td>
                    <td>${escapeHtml(row.subjectStatus)}</td>
                    <td>${escapeHtml(row.cancellationType)}</td>
                </tr>
            `).join('');

            const unmatchedTable = document.getElementById('unmatchedTable');
            unmatchedTable.innerHTML = unmatchedData.map(row => `
                <tr>
                    <td>${escapeHtml(row.patient)}</td>
                    <td>${escapeHtml(row.phone)}</td>
                    <td>${escapeHtml(row.site)}</td>
                    <td>${escapeHtml(row.study)}</td>
                    <td>${escapeHtml(row.issue)}</td>
                </tr>
            `).join('');
        }

        function downloadMatched() {
            const headers = ['PATIENT', 'PHONE #', 'SITE', 'STUDY', 'Validation_Name', 'Appointment Status', 'Subject Status', 'Appointment Cancellation Type'];
            const rows = matchedData.map(row => [
                row.patient, row.phone, row.site, row.study, row.valName,
                row.appointmentStatus, row.subjectStatus, row.cancellationType
            ]);
            downloadCSV(headers, rows, 'Matched_With_Validation.csv');
        }

        function downloadUnmatched() {
            const headers = ['PATIENT', 'PHONE #', 'SITE', 'STUDY', 'Issue'];
            const rows = unmatchedData.map(row => [row.patient, row.phone, row.site, row.study, row.issue]);
            downloadCSV(headers, rows, 'Unmatched_Records.csv');
        }

        function downloadCSV(headers, rows, filename) {
            const csv = [
                headers.map(h => `"${h}"`).join(','),
                ...rows.map(row => row.map(cell => `"${String(cell || '').replace(/"/g, '""')}"`).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = filename;
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportConfig() {
            const config = {
                siteMappings: siteMappings,
                studyMappings: studyMappings,
                exportDate: new Date().toISOString()
            };
            const json = JSON.stringify(config, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `matcher-config-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function importConfig(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const config = JSON.parse(e.target.result);
                    siteMappings = config.siteMappings || [];
                    studyMappings = config.studyMappings || [];

                    saveSiteMappings();
                    saveStudyMappings();

                    renderDragDropInterface();
                    showSuccess('Settings imported successfully!');
                } catch (err) {
                    showError('Invalid config file format');
                }
            };
            reader.readAsText(file);
        }

        // ============ UI HANDLERS ============
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }

        document.getElementById('callFile')?.addEventListener('change', (e) => {
            const name = e.target.files[0]?.name || '';
            document.getElementById('callFileName').textContent = name ? `‚úì ${name}` : '';
            updateRunBtn();
            discoverFromFiles();
        });

        document.getElementById('validationFile')?.addEventListener('change', (e) => {
            const name = e.target.files[0]?.name || '';
            document.getElementById('validationFileName').textContent = name ? `‚úì ${name}` : '';
            updateRunBtn();
            discoverFromFiles();
        });

        function updateRunBtn() {
            const callFile = document.getElementById('callFile').files.length > 0;
            const valFile = document.getElementById('validationFile').files.length > 0;
            document.getElementById('runBtn').disabled = !callFile || !valFile;
        }

        function resetForm() {
            document.getElementById('callFile').value = '';
            document.getElementById('validationFile').value = '';
            document.getElementById('callFileName').textContent = '';
            document.getElementById('validationFileName').textContent = '';
            document.getElementById('resultsSection').classList.remove('visible');
            clearMessages();
            updateRunBtn();
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.classList.add('visible');
            setTimeout(() => el.classList.remove('visible'), 5000);
        }

        function showSuccess(msg) {
            const el = document.getElementById('successMsg');
            el.textContent = msg;
            el.classList.add('visible');
            setTimeout(() => el.classList.remove('visible'), 5000);
        }

        function clearMessages() {
            document.getElementById('errorMsg').classList.remove('visible');
            document.getElementById('successMsg').classList.remove('visible');
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
            };
            return String(text || '').replace(/[&<>"']/g, m => map[m]);
        }

        // Initialize app on load
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
