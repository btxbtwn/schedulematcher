<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visit Validation Matcher</title>
    <style>
        :root {
            --color-primary: #208c8d;
            --color-primary-hover: #1d7474;
            --color-primary-active: #1a6473;
            --color-background: #fcfcf9;
            --color-surface: #ffffff;
            --color-text: #134252;
            --color-text-secondary: #626c71;
            --color-border: #5e5240;
            --color-error: #c0152f;
            --color-success: #208c8d;
            --color-warning: #a84b2f;
            --color-focus-ring: rgba(33, 128, 141, 0.4);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--color-background);
            color: var(--color-text);
            line-height: 1.5;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 28px;
            margin: 0 0 8px 0;
            font-weight: 600;
        }

        .subtitle {
            color: var(--color-text-secondary);
            margin-bottom: 24px;
            font-size: 14px;
        }

        .card {
            background: var(--color-surface);
            border: 1px solid rgba(94, 82, 64, 0.2);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .upload-box {
            border: 2px dashed rgba(94, 82, 64, 0.3);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 200ms ease;
        }

        .upload-box:hover {
            border-color: var(--color-primary);
            background: rgba(33, 128, 141, 0.02);
        }

        .upload-box input {
            display: none;
        }

        .upload-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--color-text);
            font-size: 14px;
        }

        .upload-hint {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .file-name {
            margin-top: 8px;
            font-size: 12px;
            color: var(--color-success);
            font-weight: 500;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms ease;
            display: inline-block !important;
            visibility: visible !important;
        }

        .btn-primary {
            background: var(--color-primary) !important;
            color: white !important;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--color-primary-hover) !important;
        }

        .btn-primary:active:not(:disabled) {
            background: var(--color-primary-active) !important;
        }

        .btn-primary:disabled {
            opacity: 0.5 !important;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: rgba(94, 82, 64, 0.05);
        }

        .btn-danger {
            background: var(--color-error) !important;
            color: white !important;
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(94, 82, 64, 0.2);
        }

        .tab-btn {
            padding: 12px 16px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--color-text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms ease;
        }

        .tab-btn.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .config-section {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(94, 82, 64, 0.1);
        }

        .config-section:last-child {
            border-bottom: none;
        }

        .config-section h3 {
            margin: 0 0 16px 0;
            font-size: 16px;
            font-weight: 600;
        }

        .mapping-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 12px;
            margin-bottom: 12px;
            align-items: center;
        }

        .mapping-row input {
            padding: 8px 12px;
            border: 1px solid rgba(94, 82, 64, 0.2);
            border-radius: 6px;
            font-size: 13px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .mapping-row button {
            padding: 8px 16px;
            flex-shrink: 0;
        }

        .mapping-header {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 12px;
            margin-bottom: 12px;
            font-weight: 600;
            font-size: 13px;
            color: var(--color-text);
        }

        .mapping-header div {
            text-align: center;
            padding: 8px 0;
        }

        .help-text {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-top: 8px;
            line-height: 1.4;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat {
            background: var(--color-surface);
            border: 1px solid rgba(94, 82, 64, 0.2);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 600;
            color: var(--color-text);
        }

        .results-section {
            display: none;
        }

        .results-section.visible {
            display: block;
        }

        .table-wrapper {
            overflow-x: auto;
            border: 1px solid rgba(94, 82, 64, 0.2);
            border-radius: 6px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        thead {
            background: rgba(94, 82, 64, 0.05);
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--color-text);
            border-bottom: 1px solid rgba(94, 82, 64, 0.2);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid rgba(94, 82, 64, 0.1);
        }

        tr:hover {
            background: rgba(33, 128, 141, 0.02);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.visible {
            display: block;
        }

        .spinner {
            border: 3px solid rgba(33, 128, 141, 0.2);
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(192, 21, 47, 0.1);
            border: 1px solid var(--color-error);
            border-radius: 6px;
            padding: 12px;
            color: var(--color-error);
            margin-bottom: 16px;
            display: none;
            font-size: 13px;
        }

        .error-message.visible {
            display: block;
        }

        .success-message {
            background: rgba(32, 156, 141, 0.1);
            border: 1px solid var(--color-success);
            border-radius: 6px;
            padding: 12px;
            color: var(--color-success);
            margin-bottom: 16px;
            display: none;
            font-size: 13px;
        }

        .success-message.visible {
            display: block;
        }

        .info-badge {
            display: inline-block;
            background: rgba(33, 128, 141, 0.1);
            color: var(--color-primary);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 8px;
        }

        @media (max-width: 768px) {
            .upload-section {
                grid-template-columns: 1fr;
            }

            .summary {
                grid-template-columns: repeat(2, 1fr);
            }

            button {
                width: 100%;
            }

            .mapping-row {
                grid-template-columns: 1fr;
            }

            .mapping-header {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Visit Validation Matcher</h1>
        <p class="subtitle">Upload your call log and data validation export to match and extract appointment data</p>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('matcher')">üìä Matcher</button>
            <button class="tab-btn" onclick="switchTab('config')">üè• Sites and Studies</button>
        </div>

        <!-- MATCHER TAB -->
        <div id="matcherTab" class="tab-content active">
            <div class="card">
                <div class="error-message" id="errorMsg"></div>
                <div class="success-message" id="successMsg"></div>

                <div class="upload-section">
                    <div class="upload-box" onclick="document.getElementById('callFile').click()">
                        <label class="upload-label">üìÑ Grove Schedules</label>
                        <p class="upload-hint">Click to upload or drag & drop</p>
                        <input type="file" id="callFile" accept=".csv" />
                        <div class="file-name" id="callFileName"></div>
                    </div>

                    <div class="upload-box" onclick="document.getElementById('validationFile').click()">
                        <label class="upload-label">üìã CRIO Schedules</label>
                        <p class="upload-hint">Click to upload or drag & drop</p>
                        <input type="file" id="validationFile" accept=".csv" />
                        <div class="file-name" id="validationFileName"></div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn-primary" id="runBtn" onclick="runMatching()" disabled>Run Matching</button>
                    <button class="btn-secondary" onclick="resetForm()">Clear</button>
                    <button class="btn-primary" style="background-color: #e91e63; margin-left: 10px;" onclick="updateTrackerStatus()">Update Tracker Statuses</button>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processing your files...</p>
            </div>

            <div class="results-section" id="resultsSection">
                <div class="card">
                    <h2 style="margin: 0 0 20px 0;">Results Summary</h2>
                    <div class="summary">
                        <div class="stat">
                            <div class="stat-label">Total Records</div>
                            <div class="stat-value" id="totalCount">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Matched</div>
                            <div class="stat-value" id="matchedCount" style="color: var(--color-success);">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Unmatched</div>
                            <div class="stat-value" id="unmatchedCount" style="color: var(--color-error);">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Success Rate</div>
                            <div class="stat-value" id="successRate">0%</div>
                        </div>
                    </div>
                </div>
                            
            <div style="text-align: center; margin-top: 16px;">
                <button class="btn-primary" onclick="downloadMasterExport()" style="font-size: 16px; padding: 12px 24px;">
                    üì¶ Export Master File (All Records)
                </button>
            </div>


                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h2 style="margin: 0;">Matched Records (<span id="matchedDisplayCount">0</span>)</h2>
                        <button class="btn-primary" onclick="downloadMatched()">‚¨áÔ∏è Export Matched</button>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Patient</th>
                                    <th>Phone</th>
                                    <th>Site</th>
                                    <th>Study</th>
                                    <th>Validation Name</th>
                                    <th>Appointment Status</th>
                                    <th>Subject Status</th>
                                    <th>Cancellation Type</th>
                                </tr>
                            </thead>
                            <tbody id="matchedTable"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h2 style="margin: 0;">Unmatched Records (<span id="unmatchedDisplayCount">0</span>)</h2>
                        <button class="btn-primary" onclick="downloadUnmatched()">‚¨áÔ∏è Export Unmatched</button>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Patient</th>
                                    <th>Phone</th>
                                    <th>Site</th>
                                    <th>Study</th>
                                    <th>Issue</th>
                                </tr>
                            </thead>
                            <tbody id="unmatchedTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- SITES AND STUDIES TAB -->
        <div id="configTab" class="tab-content">
            <div class="card">
                <div class="config-section">
                    <h3>üè• Site Mappings<span class="info-badge" id="siteMappingCount">0 mappings</span></h3>
                    <p class="help-text">Match site names between Grove and CRIO. Sites are automatically discovered when you upload files. Each row creates a pair that the app will recognize as the same location.</p>
                    <div class="mapping-header">
                        <div>Grove Site</div>
                        <div>CRIO Site</div>
                        <div style="width: 80px;"></div>
                    </div>
                    <div id="siteMappings"></div>
                    <button class="btn-primary" onclick="addSiteMapping()" style="margin-top: 12px;">+ Add Site Match</button>
                </div>

                <div class="config-section">
                    <h3>üìö Study Mappings<span class="info-badge" id="studyMappingCount">0 mappings</span></h3>
                    <p class="help-text">Match study names between Grove and CRIO. Studies are automatically discovered when you upload files. Each row creates a pair that the app will recognize as the same study.</p>
                    <div class="mapping-header">
                        <div>Grove Study</div>
                        <div>CRIO Study</div>
                        <div style="width: 80px;"></div>
                    </div>
                    <div id="studyMappings"></div>
                    <button class="btn-primary" onclick="addStudyMapping()" style="margin-top: 12px;">+ Add Study Match</button>
                </div>

                <div class="config-section">
                    <h3>üíæ Export / Import Settings</h3>
                    <p class="help-text">Save your mappings and share them with team members or use on another device.</p>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn-primary" onclick="exportConfig()">‚¨áÔ∏è Export Settings</button>
                        <button class="btn-primary" onclick="document.getElementById('importFile').click()">‚¨ÜÔ∏è Import Settings</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importConfig(event)" />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ INITIALIZATION ============
        let matchedData = [];
        let unmatchedData = [];
        let siteMappings = [];
        let studyMappings = [];
        let discoveredGroveSites = new Set();
        let discoveredCrioSites = new Set();
        let discoveredGroveStudies = new Set();
        let discoveredCrioStudies = new Set();

        // Load all data from localStorage on startup
        function initializeApp() {
            loadSiteMappings();
            loadStudyMappings();
            renderSiteMappings();
            renderStudyMappings();
        }

        // ============ LOCAL STORAGE FUNCTIONS ============
        function loadSiteMappings() {
            const saved = localStorage.getItem('siteMappings');
            siteMappings = saved ? JSON.parse(saved) : [];
        }

        function saveSiteMappings() {
            localStorage.setItem('siteMappings', JSON.stringify(siteMappings));
        }

        function loadStudyMappings() {
            const saved = localStorage.getItem('studyMappings');
            studyMappings = saved ? JSON.parse(saved) : getDefaultStudyMappings();
        }

        function getDefaultStudyMappings() {
            return [
                { grove: 'MRNA-1273', crio: '1273' },
                { grove: 'MRNA-1273', crio: 'MODERNA 1273' },
                { grove: 'MRNA-1403', crio: '1403' },
                { grove: 'MRNA-1403', crio: 'MODERNA 1403' },
                { grove: 'VAXCYTE', crio: 'VAX31' },
                { grove: 'NOVAVAX', crio: 'NOVAVAX' },
                { grove: 'VIKING', crio: 'VIKING' }
            ];
        }

        function saveStudyMappings() {
            localStorage.setItem('studyMappings', JSON.stringify(studyMappings));
        }

        // ============ AUTO-DISCOVERY FROM FILES ============
        function discoverFromFiles() {
            const callFile = document.getElementById('callFile').files[0];
            const valFile = document.getElementById('validationFile').files[0];

            if (!callFile && !valFile) return;

            Promise.all([
                callFile ? callFile.text() : Promise.resolve(null),
                valFile ? valFile.text() : Promise.resolve(null)
            ]).then(([callText, valText]) => {
                if (callText) {
                    const callData = parseCSV(callText);
                    extractGroveData(callData);
                }
                if (valText) {
                    const valData = parseCSV(valText);
                    extractCrioData(valData);
                }
                autoPopulateMappings();
            }).catch(err => {
                console.error('Discovery error:', err);
            });
        }

        function extractGroveData(data) {
            data.rows.forEach(row => {
                const site = row['SITE'];
                const study = row['STUDY'];
                if (site && site.trim()) discoveredGroveSites.add(site.trim());
                if (study && study.trim()) discoveredGroveStudies.add(study.trim());
            });
        }

        function extractCrioData(data) {
            data.rows.forEach(row => {
                const site = row['Site Name'];
                const study = row['Study Name'];
                if (site && site.trim()) discoveredCrioSites.add(site.trim());
                if (study && study.trim()) discoveredCrioStudies.add(study.trim());
            });
        }

        function autoPopulateMappings() {
            let newSites = 0;
            let newStudies = 0;

            // Auto-populate sites
            discoveredGroveSites.forEach(groveSite => {
                // Check if this Grove site already has a mapping
                const exists = siteMappings.some(m => m.grove === groveSite);
                if (!exists) {
                    siteMappings.push({ grove: groveSite, crio: '' });
                    newSites++;
                }
            });

            discoveredCrioSites.forEach(crioSite => {
                // Check if this CRIO site already has a mapping
                const exists = siteMappings.some(m => m.crio === crioSite);
                if (!exists) {
                    siteMappings.push({ grove: '', crio: crioSite });
                    newSites++;
                }
            });

            // Auto-populate studies
            discoveredGroveStudies.forEach(groveStudy => {
                const exists = studyMappings.some(m => m.grove === groveStudy);
                if (!exists) {
                    studyMappings.push({ grove: groveStudy, crio: '' });
                    newStudies++;
                }
            });

            discoveredCrioStudies.forEach(crioStudy => {
                const exists = studyMappings.some(m => m.crio === crioStudy);
                if (!exists) {
                    studyMappings.push({ grove: '', crio: crioStudy });
                    newStudies++;
                }
            });

            if (newSites > 0 || newStudies > 0) {
                saveSiteMappings();
                saveStudyMappings();
                renderSiteMappings();
                renderStudyMappings();
                
                const message = [];
                if (newSites > 0) message.push(`${newSites} new site(s)`);
                if (newStudies > 0) message.push(`${newStudies} new study/studies`);
                showSuccess(`‚úì Auto-discovered ${message.join(' and ')}! Check the Sites and Studies tab to map them.`);
            }
        }

        // ============ SITE MAPPINGS ============
        function renderSiteMappings() {
            const container = document.getElementById('siteMappings');
            const countBadge = document.getElementById('siteMappingCount');
            
            countBadge.textContent = `${siteMappings.length} mapping${siteMappings.length !== 1 ? 's' : ''}`;

            if (siteMappings.length === 0) {
                container.innerHTML = '<p style="color: var(--color-text-secondary); font-size: 13px;">No site mappings yet. Upload files to auto-discover sites, or add manually.</p>';
                return;
            }

            container.innerHTML = siteMappings.map((mapping, idx) => `
                <div class="mapping-row">
                    <input type="text" placeholder="Grove site name" value="${escapeHtml(mapping.grove)}" 
                           onchange="updateSiteMapping(${idx}, 'grove', this.value)">
                    <input type="text" placeholder="CRIO site name" value="${escapeHtml(mapping.crio)}" 
                           onchange="updateSiteMapping(${idx}, 'crio', this.value)">
                    <button class="btn-danger" onclick="deleteSiteMapping(${idx})">Delete</button>
                </div>
            `).join('');
        }

        function addSiteMapping() {
            siteMappings.push({ grove: '', crio: '' });
            saveSiteMappings();
            renderSiteMappings();
        }

        function updateSiteMapping(idx, field, value) {
            siteMappings[idx][field] = value.trim();
            saveSiteMappings();
        }

        function deleteSiteMapping(idx) {
            if (confirm('Delete this site mapping?')) {
                siteMappings.splice(idx, 1);
                saveSiteMappings();
                renderSiteMappings();
            }
        }

        // ============ STUDY MAPPINGS ============
        function renderStudyMappings() {
            const container = document.getElementById('studyMappings');
            const countBadge = document.getElementById('studyMappingCount');
            
            countBadge.textContent = `${studyMappings.length} mapping${studyMappings.length !== 1 ? 's' : ''}`;

            if (studyMappings.length === 0) {
                container.innerHTML = '<p style="color: var(--color-text-secondary); font-size: 13px;">No study mappings yet. Upload files to auto-discover studies, or add manually.</p>';
                return;
            }

            container.innerHTML = studyMappings.map((mapping, idx) => `
                <div class="mapping-row">
                    <input type="text" placeholder="Grove study name" value="${escapeHtml(mapping.grove)}" 
                           onchange="updateStudyMapping(${idx}, 'grove', this.value)">
                    <input type="text" placeholder="CRIO study name" value="${escapeHtml(mapping.crio)}" 
                           onchange="updateStudyMapping(${idx}, 'crio', this.value)">
                    <button class="btn-danger" onclick="deleteStudyMapping(${idx})">Delete</button>
                </div>
            `).join('');
        }

        function addStudyMapping() {
            studyMappings.push({ grove: '', crio: '' });
            saveStudyMappings();
            renderStudyMappings();
        }

        function updateStudyMapping(idx, field, value) {
            studyMappings[idx][field] = value.trim();
            saveStudyMappings();
        }

        function deleteStudyMapping(idx) {
            if (confirm('Delete this study mapping?')) {
                studyMappings.splice(idx, 1);
                saveStudyMappings();
                renderStudyMappings();
            }
        }

        // ============ MATCHING LOGIC ============
        function cleanPhone(val) {
            if (!val || val === null) return null;
            const s = String(val).trim();
            const digits = s.replace(/\D/g, '');
            if (!digits) return null;
            return digits.length >= 10 ? digits.slice(-10) : digits;
        }

        function normalizeSite(site, source) {
            if (!site || site === null) return null;
            const s = String(site).trim().toUpperCase();
            
            // Check mappings
            for (const mapping of siteMappings) {
                if (!mapping.grove || !mapping.crio) continue;
                const groveUpper = mapping.grove.toUpperCase();
                const crioUpper = mapping.crio.toUpperCase();
                
                if (source === 'grove' && s.includes(groveUpper)) {
                    return groveUpper;
                } else if (source === 'crio' && s.includes(crioUpper)) {
                    // Return the Grove equivalent for matching
                    return mapping.grove.toUpperCase();
                }
            }
            
            // If no mapping found, take first word
            return s.split(/[\s\-]/)[0];
        }

        function normalizeStudy(study, source) {
            if (!study || study === null) return 'UNKNOWN';
            const s = String(study).toUpperCase();

            // Check mappings
            for (const mapping of studyMappings) {
                if (!mapping.grove || !mapping.crio) continue;
                const groveUpper = mapping.grove.toUpperCase();
                const crioUpper = mapping.crio.toUpperCase();
                
                if (source === 'grove' && s.includes(groveUpper)) {
                    return groveUpper;
                } else if (source === 'crio' && s.includes(crioUpper)) {
                    // Return the Grove equivalent for matching
                    return mapping.grove.toUpperCase();
                }
            }

            return s.substring(0, 60);
        }

        function parseCSV(text) {
            const lines = text.split('\n').filter(l => l.trim());
            if (lines.length < 2) throw new Error('CSV file appears to be empty');

            const headers = lines[0].split(',').map(h => h.trim().replace(/^\"|\"$/g, ''));
            const rows = [];

            for (let i = 1; i < lines.length; i++) {
                const values = [];
                let current = '';
                let inQuotes = false;

                for (let j = 0; j < lines[i].length; j++) {
                    const char = lines[i][j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim().replace(/^\"|\"$/g, ''));
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim().replace(/^\"|\"$/g, ''));

                const row = {};
                headers.forEach((h, idx) => {
                    row[h] = values[idx] || '';
                });
                rows.push(row);
            }

            return { headers, rows };
        }

        function runMatching() {
            const callFile = document.getElementById('callFile').files[0];
            const valFile = document.getElementById('validationFile').files[0];

            if (!callFile || !valFile) {
                showError('Please upload both files');
                return;
            }

            document.getElementById('loading').classList.add('visible');
            document.getElementById('resultsSection').classList.remove('visible');
            clearMessages();

            Promise.all([
                callFile.text(),
                valFile.text()
            ]).then(([callText, valText]) => {
                const callData = parseCSV(callText);
                const valData = parseCSV(valText);
                performMatch(callData, valData);
            }).catch(err => {
                showError(`Error reading files: ${err.message}`);
                document.getElementById('loading').classList.remove('visible');
            });
        }

        function performMatch(callData, valData) {
            try {
                // Prepare validation data
                const valMap = new Map();
                valData.rows.forEach(row => {
                    const phoneClean = cleanPhone(row['Mobile Phone']);
                    const siteNorm = normalizeSite(row['Site Name'], 'crio');
                    const studyNorm = normalizeStudy(row['Study Name'], 'crio');

                    if (phoneClean && siteNorm) {
                        const key = `${phoneClean}|${siteNorm}|${studyNorm}`;
                        valMap.set(key, {
    name: row['Subject Full Name'] || '',
    phone: row['Mobile Phone'] || '',
    scheduledTime: row['Scheduled Time'] || '',  // ‚úÖ ADD THIS LINE
    appointmentStatus: row['Appointment Status'] || '',
    subjectStatus: row['Subject Status'] || '',
    cancellationType: row['Appointment Cancellation Type'] || ''
});
                    }
                });

                // Perform matching
                matchedData = [];
                unmatchedData = [];

                callData.rows.forEach(row => {
                    const phoneClean = cleanPhone(row['Phone #']);  // Changed from 'PHONE #'
                    const siteNorm = normalizeSite(row['Site'], 'grove');  // Changed from 'SITE'
                    const studyNorm = normalizeStudy(row['Study'], 'grove');  // Changed from 'STUDY'
                    const key = `${phoneClean}|${siteNorm}|${studyNorm}`;

                    const match = valMap.get(key);

                   if (match) {
    matchedData.push({
        patient: row['Title'] || '',
        phone: row['Phone #'] || '',
        site: row['Site'] || '',
        study: row['Study'] || '',
        createdTime: row['Created At'] || '',  // ‚úÖ ADD THIS LINE
        valName: match.name,
        scheduledTime: match.scheduledTime || '',  // ‚úÖ ADD THIS LINE
        appointmentStatus: match.appointmentStatus,
        subjectStatus: match.subjectStatus,
        cancellationType: match.cancellationType
    });
} else {
    unmatchedData.push({
        patient: row['Title'] || '',
        phone: row['Phone #'] || '',
        site: row['Site'] || '',
        study: row['Study'] || '',
        createdTime: row['Created At'] || '',
        visitTime: row['Visit Time'] || '',  // ‚úÖ ADD THIS LINE
        issue: 'No match found'
    });
}

                });

                displayResults();
                document.getElementById('loading').classList.remove('visible');
                document.getElementById('resultsSection').classList.add('visible');
                showSuccess(`‚úì Matching complete: ${matchedData.length} matched, ${unmatchedData.length} unmatched`);

            } catch (err) {
                showError(`Matching error: ${err.message}`);
                document.getElementById('loading').classList.remove('visible');
            }
        }

        function displayResults() {
            const total = matchedData.length + unmatchedData.length;
            const matched = matchedData.length;
            const unmatched = unmatchedData.length;
            const rate = total > 0 ? Math.round((matched / total) * 100) : 0;

            document.getElementById('totalCount').textContent = total;
            document.getElementById('matchedCount').textContent = matched;
            document.getElementById('unmatchedCount').textContent = unmatched;
            document.getElementById('successRate').textContent = `${rate}%`;
            document.getElementById('matchedDisplayCount').textContent = matched;
            document.getElementById('unmatchedDisplayCount').textContent = unmatched;

            const matchedTable = document.getElementById('matchedTable');
            matchedTable.innerHTML = matchedData.map(row => `
                <tr>
                    <td>${escapeHtml(row.patient)}</td>
                    <td>${escapeHtml(row.phone)}</td>
                    <td>${escapeHtml(row.site)}</td>
                    <td>${escapeHtml(row.study)}</td>
                    <td>${escapeHtml(row.valName)}</td>
                    <td>${escapeHtml(row.appointmentStatus)}</td>
                    <td>${escapeHtml(row.subjectStatus)}</td>
                    <td>${escapeHtml(row.cancellationType)}</td>
                </tr>
            `).join('');

            const unmatchedTable = document.getElementById('unmatchedTable');
            unmatchedTable.innerHTML = unmatchedData.map(row => `
                <tr>
                    <td>${escapeHtml(row.patient)}</td>
                    <td>${escapeHtml(row.phone)}</td>
                    <td>${escapeHtml(row.site)}</td>
                    <td>${escapeHtml(row.study)}</td>
                    <td>${escapeHtml(row.issue)}</td>
                </tr>
            `).join('');
        }

        function downloadMatched() {
            const headers = ['PATIENT', 'PHONE #', 'SITE', 'STUDY', 'Validation_Name', 'Appointment Status', 'Subject Status', 'Appointment Cancellation Type'];
            const rows = matchedData.map(row => [
                row.patient, row.phone, row.site, row.study, row.valName,
                row.appointmentStatus, row.subjectStatus, row.cancellationType
            ]);
            downloadCSV(headers, rows, 'Matched_With_Validation.csv');
        }

        function downloadUnmatched() {
            const headers = ['PATIENT', 'PHONE #', 'SITE', 'STUDY', 'Issue'];
            const rows = unmatchedData.map(row => [row.patient, row.phone, row.site, row.study, row.issue]);
            downloadCSV(headers, rows, 'Unmatched_Records.csv');
        }

  function downloadMasterExport() {
    const headers = [
        'PATIENT', 
        'PHONE #', 
        'SITE', 
        'STUDY', 
        'STATUS',
        'Created At (Grove)',
        'Validation_Name', 
        'Visit Date/Time',
        'Appointment Status', 
        'Subject Status', 
        'Appointment Cancellation Type',
        'Issue/Notes'
    ];
    
    const rows = [];  // ‚úÖ ADD THIS LINE - Initialize empty array
    
    matchedData.forEach(row => {
        rows.push([
            row.patient,
            row.phone,
            row.site,
            row.study,
            'MATCHED',
            row.createdTime || '',
            row.valName,
            row.scheduledTime || '',
            row.appointmentStatus,
            row.subjectStatus,
            row.cancellationType,
            ''
        ]);
    });
    
    unmatchedData.forEach(row => {
    rows.push([
        row.patient,
        row.phone,
        row.site,
        row.study,
        'UNMATCHED',
        row.createdTime || '',
        '',  // No validation name for unmatched
        row.visitTime || '',  // ‚úÖ CHANGE THIS - Use Grove visit time
        '',
        '',
        '',
        row.issue
    ]);
});
    
    const today = new Date().toISOString().split('T')[0];
    const filename = `Master_Export_${today}.csv`;
    
    downloadCSV(headers, rows, filename);
    showSuccess(`‚úì Master export complete: ${matchedData.length} matched + ${unmatchedData.length} unmatched = ${rows.length} total records`);
}

        function downloadCSV(headers, rows, filename) {
            const csv = [
                headers.map(h => `"${h}"`).join(','),
                ...rows.map(row => row.map(cell => `"${String(cell || '').replace(/"/g, '""')}"`).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = filename;
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportConfig() {
            const config = {
                siteMappings: siteMappings,
                studyMappings: studyMappings,
                exportDate: new Date().toISOString()
            };
            const json = JSON.stringify(config, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `matcher-config-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function importConfig(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const config = JSON.parse(e.target.result);
                    siteMappings = config.siteMappings || [];
                    studyMappings = config.studyMappings || [];

                    saveSiteMappings();
                    saveStudyMappings();

                    renderSiteMappings();
                    renderStudyMappings();

                    showSuccess('Settings imported successfully!');
                } catch (err) {
                    showError('Invalid config file format');
                }
            };
            reader.readAsText(file);
        }

        // ============ UI HANDLERS ============
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }

        document.getElementById('callFile')?.addEventListener('change', (e) => {
            const name = e.target.files[0]?.name || '';
            document.getElementById('callFileName').textContent = name ? `‚úì ${name}` : '';
            updateRunBtn();
            discoverFromFiles();
        });

        document.getElementById('validationFile')?.addEventListener('change', (e) => {
            const name = e.target.files[0]?.name || '';
            document.getElementById('validationFileName').textContent = name ? `‚úì ${name}` : '';
            updateRunBtn();
            discoverFromFiles();
        });

        function updateRunBtn() {
            const callFile = document.getElementById('callFile').files.length > 0;
            const valFile = document.getElementById('validationFile').files.length > 0;
            document.getElementById('runBtn').disabled = !callFile || !valFile;
        }

        function resetForm() {
            document.getElementById('callFile').value = '';
            document.getElementById('validationFile').value = '';
            document.getElementById('callFileName').textContent = '';
            document.getElementById('validationFileName').textContent = '';
            document.getElementById('resultsSection').classList.remove('visible');
            clearMessages();
            updateRunBtn();
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.classList.add('visible');
            setTimeout(() => el.classList.remove('visible'), 5000);
        }

        function showSuccess(msg) {
            const el = document.getElementById('successMsg');
            el.textContent = msg;
            el.classList.add('visible');
            setTimeout(() => el.classList.remove('visible'), 5000);
        }

        function clearMessages() {
            document.getElementById('errorMsg').classList.remove('visible');
            document.getElementById('successMsg').classList.remove('visible');
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
            };
            return String(text || '').replace(/[&<>"']/g, m => map[m]);
        }

        // Initialize app on load
// ============ FINAL EXPORT FUNCTION (Clean Headers) ============
function updateTrackerStatus() {
    const callFile = document.getElementById('callFile').files[0];
    const valFile = document.getElementById('validationFile').files[0];

    if (!callFile || !valFile) {
        alert('Please upload both files first.');
        return;
    }

    const centralSites = ['NO', 'DAL', 'TUL', 'BR', 'NAS', 'LOU', 'STL', 'IND', 'CIN', 'SPR'];

    Promise.all([callFile.text(), valFile.text()]).then(([callText, valText]) => {
        const trackerData = parseTrackerCSV(callText);
        const crioData = parseCSV(valText);
        
        const updatedRows = trackerData.rows.map(tRow => {
            const tPatient = (tRow['PATIENT'] || '').trim().toLowerCase();
            const rawPhone = tRow['PHONE #'] || tRow['PHONE'] || '';
            const tPhone = rawPhone.replace(/\D/g, '').slice(-4);
            const tSite = (tRow['SITE'] || '').trim().toUpperCase();

            // STRICT MATCHING LOGIC
            const match = crioData.rows.find(cRow => {
                const cPhone = (cRow['Mobile Phone'] || cRow['Home Phone'] || '').replace(/\D/g, '').slice(-4);
                const cPatient = (cRow['Subject Full Name'] || cRow['Full Name'] || '').trim().toLowerCase();
                const cSite = (cRow['Site Name'] || '').toUpperCase();

                // 1. Phone last 4 MUST match
                if (!tPhone || tPhone !== cPhone) return false;

                // 2. Site MUST match (e.g., Tracker 'ATL' must be in CRIO 'ATL - Psych')
                if (!cSite.includes(tSite)) return false;

                // 3. Name check (Optional but recommended for safety)
                // If the name is completely different, it's probably the wrong person with the same phone digits
                const tNameParts = tPatient.split(' ');
                const matchesName = tNameParts.some(part => part.length > 2 && cPatient.includes(part));
                
                return matchesName;
            });

            if (match) {
                const schedTime = match['Scheduled Time'] || '';
                let newDate = tRow['DATE'];
                let newTime = tRow['TIME'];

                if (schedTime && schedTime.includes(' ')) {
                    const parts = schedTime.split(' ');
                    const dateParts = parts[0].split('-');
                    const timeParts = parts[1].split(':');

                    if (dateParts.length === 3 && timeParts.length >= 2) {
                        let hours = parseInt(timeParts[0]);
                        let minutes = timeParts[1];
                        if (centralSites.some(s => tSite.includes(s))) hours -= 1;

                        newDate = `${parseInt(dateParts[1])}/${parseInt(dateParts[2])}/${dateParts[0]}`;
                        let ampm = hours >= 12 ? 'PM' : 'AM';
                        if (hours > 12) hours -= 12;
                        if (hours === 0) hours = 12;
                        if (hours < 0) { hours = 11; ampm = 'PM'; }
                        newTime = `${hours}:${minutes} ${ampm}`;
                    }
                }

                return {
                    ...tRow,
                    'DATE': newDate,
                    'TIME': newTime,
                    'Appointment Status': match['Appointment Status'] || '',
                    'Subject Status': match['Subject Status'] || '',
                    'Appointment Cancellation Type': match['Appointment Cancellation Type'] || ''
                };
            }
            return tRow;
        });

        downloadUpdatedCSV(trackerData, updatedRows);
    }).catch(err => alert('Error: ' + err.message));
}

// Helper: Finds the real header row and skips the top summary lines
function parseTrackerCSV(text) {
    const lines = text.split(/\r\n|\n/);
    // Look for the row that starts with DATE
    const headerIndex = lines.findIndex(l => l.toUpperCase().startsWith('DATE,TIME,PATIENT') || l.toUpperCase().includes(',PATIENT,PHONE'));
    
    if (headerIndex === -1) throw new Error('Could not find header row starting with DATE,TIME,PATIENT');

    // Extract headers from that line
    const headers = lines[headerIndex].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
    
    const rows = [];
    for(let i = headerIndex + 1; i < lines.length; i++) {
        if(!lines[i].trim()) continue;
        
        // Handle CSV split ensuring commas in quotes are preserved
        const values = [];
        let inQuote = false;
        let val = '';
        for (let char of lines[i]) {
            if (char === '"') inQuote = !inQuote;
            else if (char === ',' && !inQuote) { values.push(val); val = ''; }
            else val += char;
        }
        values.push(val);
        
        const row = {};
        headers.forEach((h, idx) => {
             let v = values[idx] || '';
             v = v.replace(/^"|"$/g, '').trim();
             row[h] = v;
        });
        rows.push(row);
    }
    return { headers, rows };
}

// Helper: Exports headers first, then data
function downloadUpdatedCSV(originalData, updatedRows) {
    const headers = [...originalData.headers];
    // Add new columns if they don't exist
    ['Appointment Status', 'Subject Status', 'Appointment Cancellation Type'].forEach(col => {
        if (!headers.includes(col)) headers.push(col);
    });

    // Create the CSV content
    const csvRows = updatedRows.map(row => headers.map(h => {
        let val = row[h] || '';
        // Escape quotes and wrap in quotes if necessary
        if (typeof val === 'string') {
            val = val.replace(/"/g, '""');
            if (val.includes(',') || val.includes('\n')) val = `"${val}"`;
        }
        return val;
    }).join(',')).join('\n');

    // Header Row is now truly the first row
    const finalContent = headers.join(',') + '\n' + csvRows;

    const blob = new Blob([finalContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'Updated_Grove_Tracker.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
